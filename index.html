<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>BoniniF mail storage</title>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #10330a;
            margin: 0;
            padding: 20px;
        }
        h1 { color: #333; }
        button {
            padding: 8px 16px;
            background: #013220;
            color: #fff;
            border: none;
            border-radius: 9px;
            margin: 0 7px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.2s, color 0.15s, box-shadow .25s;
        }
        button:hover {
            box-shadow: 0px 4px 16px rgba(1,50,32,.18), inset 0 -1.5rem .8rem -1rem rgba(255,255,255,.07);
        }
        #content { margin-top: 20px; }
        .email {
            padding: 10px;
            margin-bottom: 15px;
            position: relative;
            background: rgba(255,255,255,0.3);
            color: #013220;
            border-radius: 25px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            backdrop-filter: blur(4px);
        }
        .email strong { color: #555; }
        .email-body {
            border: 1px solid #ccc;
            padding: 10px;
            background: white;
            overflow-x: auto;
            margin-top: 10px;
            display: none;
        }
        #bulk-actions {
            position: fixed;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            z-index: 10000;
            background: rgba(255,255,255,0.3);
            color: #013220;
            border-radius: 25px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            padding: 14px 36px 16px 36px;
            display: none;
            font-size: 1.07em;
            backdrop-filter: blur(4px);
            align-items: center;
            gap: 9px;
        }
        @media (max-width:600px) {
            #tabs-bar {
                width: 100vw;
                left: 0;
                transform: none;
                padding-top: 18px;
                min-height: 32px;
            }
            #bulk-actions {
                width: 98vw;
                left: 1vw;
                transform: none;
                padding: 9px 0 9px 0;
                border-radius: 12px;
                font-size: 0.97em;
            }
        }
        .email-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }
        #tabs-bar {
            width: 100vw;
            margin: 0;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            min-height: 48px;
            display: flex;
            align-items: flex-end;
            padding-top: 30px;
            box-sizing: border-box;
        }
        .tab-btn { border:none; background:transparent; font-size:1.1em; padding:12px 18px; cursor:pointer; }
        .tab-btn.active { background:#013220; color:#fff; border-radius:8px 8px 0 0; }
        .expand-collapse { cursor:pointer; font-size:1.4em; color:#357AE8; user-select:none; margin-right:6px; }
        .expand-collapse[aria-expanded="true"] { color: #013220; }
        .email-date { color:#888; font-size:0.97em; margin-left:12px; }
        .tab-btn:not(.active) {
            background: rgba(255,255,255,.3);
            backdrop-filter: blur(4px);
            color:#013220 !important;
            border-radius:12px 12px 0 0;
        }
        #tabs-bar::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -6px;
            width: 100%;
            height: 14px;
            z-index: -1;
            background: rgba(255,255,255,.23);
            box-shadow: none;
            backdrop-filter: blur(5.7px);
            border-radius: 13pt;
            pointer-events: none;
        }
        #tabs-bar .tab-btn, #tabs-bar > button {
            margin-left: auto;
            margin-right: auto;
        }
        #tabs-bar > .tab-btn {
            margin: 0 2px;
        }
        #tabs-bar .tabs-inner {
            display: flex;
            justify-content: center;
            width: 100%;
        }
        /* ... altri stili invariati ... */
    </style>
</head>
<body>

<h1>Archivio</h1>
<div id="archive-content">Nessuna email archiviata.</div>

<div id="tabs-bar" style="display:flex;justify-content:center;margin:22px 0;"></div>
<div id="tabs-content"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
let githubToken = null;
let githubUsername = null;
let archiveEmails = [];

const OUTLOOK_CLIENT_ID = '5dcc792b-ad91-4d6b-88e8-44e149c4b885';
const OUTLOOK_REDIRECT_URI = window.location.origin + window.location.pathname;
const msalConfig = {
    auth: {
        clientId: OUTLOOK_CLIENT_ID,
        authority: "https://login.microsoftonline.com/common",
        redirectUri: OUTLOOK_REDIRECT_URI
    }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const loginRequest = {
    scopes: ["Mail.Read", "offline_access", "User.Read"]
};

const tabs = [
    {
        id: "tab-archivio",
        type: "archivio",
        label: "Archivio",
        loader: loadArchiveTab,
        alwaysReload: true,
        active: true
    }
];
let tabCounter = 1;

function renderTabs() {
    const bar = document.getElementById('tabs-bar');
    bar.innerHTML = '';
    tabs.forEach((tab) => {
        const btn = document.createElement('button');
        btn.textContent = tab.label;
        btn.className = 'tab-btn' + (tab.active ? ' active' : '');
        btn.onclick = () => selectTab(tab.id);
        bar.appendChild(btn);
    });
    const plus = document.createElement('button');
    plus.textContent = '+';
    plus.className = 'tab-btn';
    plus.setAttribute('style', 'border-radius: 50px; padding: 12px 17px;');
    plus.onclick = openTabSelector;
    bar.appendChild(plus);
}

function openTabSelector() {
    // Choose service Google/Outlook
    const type = prompt("Scegli servizio: 'google' o 'outlook'");
    if (type === "google") {
        addTab('gmail', 'Gmail', loadGmailTab);
    } else if (type === "outlook") {
        addTab('outlook', 'Outlook', loadOutlookTab);
    } else {
        alert("Servizio non valido.");
    }
}

function addTab(type, label, loaderFn) {
    const id = `tab-${type}-${++tabCounter}`;
    tabs.push({ id, type, label, loader: loaderFn, loaded: false });
    selectTab(id);
    renderTabs();
}
function selectTab(tabId) {
    tabs.forEach(t => t.active = (t.id === tabId));
    renderTabs();
    const tab = tabs.find(t => t.id === tabId);
    const container = document.getElementById('tabs-content');
    if (tab.type === 'archivio') {
        tab.loader(tab, container);
    } else if (tab.loader) {
        tab.loader(tab, container);
        tab.loaded = true;
    }
}

window.addEventListener('DOMContentLoaded', function() {
    renderTabs();
    selectTab(tabs[0].id);
});

function loadArchiveTab(tab, container) {
    container.innerHTML = `<div id="archive-content"></div>`;
    updateArchiveContent();
}

function updateArchiveContent() {
    const div = document.getElementById('archive-content');
    if (!archiveEmails.length) {
        div.innerHTML = "Nessuna email archiviata.";
        return;
    }
    let html = '';
    for (const email of archiveEmails) {
        html += `
        <div class="email">
            <strong>Oggetto:</strong> ${email.subject}<br>
            <strong>Data:</strong> ${email.date}<br>
            <strong>Da:</strong> ${email.from}<br>
            <div class="email-body" style="display:block">${email.body}</div>
            <div>
                <button onclick="downloadEmailAsHTML('${email.id}', '${sanitizeFilename(email.subject)}')">Scarica HTML</button>
            </div>
        </div>
        `;
    }
    div.innerHTML = html;
}

function sanitizeFilename(name) {
    return name.replace(/[^a-z0-9_\-]/gi, '_');
}

// OUTLOOK
async function loadOutlookTab(tab, container) {
    container.innerHTML = `<div id="outlook-content">Caricamento email Outlook...</div>`;
    const token = await outlookGetToken();
    if (!token) {
        container.innerHTML = 'Login Outlook richiesto.';
        return;
    }
    await fetchOutlookMessages(token, "outlook-content");
}

async function outlookGetToken() {
    try {
        const loginResponse = await msalInstance.loginPopup(loginRequest);
        const account = loginResponse.account;
        const accessTokenResponse = await msalInstance.acquireTokenSilent({
            ...loginRequest,
            account: account
        }).catch(() => {
            return msalInstance.acquireTokenPopup(loginRequest);
        });
        return accessTokenResponse.accessToken;
    } catch (e) { return null; }
}

async function fetchOutlookMessages(token, containerId) {
    const div = document.getElementById(containerId);
    div.innerHTML = 'Caricamento email Outlook...';
    const res = await fetch('https://graph.microsoft.com/v1.0/me/mailfolders/inbox/messages?$top=30', {
        headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    if (!data.value || !Array.isArray(data.value) || data.value.length === 0) {
        div.innerHTML = 'Nessun messaggio trovato nella casella Outlook.';
        return;
    }
    const output = data.value.map(msg => `
    <div class="email" id="email-${msg.id}">
        <strong>Da:</strong> ${msg.from?.emailAddress?.name || ''} &lt;${msg.from?.emailAddress?.address || ''}&gt;
        <span class="email-date">${msg.receivedDateTime ? new Date(msg.receivedDateTime).toLocaleString() : ''}</span><br>
        <strong>Oggetto:</strong> ${msg.subject || '(Senza oggetto)'}
        <span class="expand-collapse" onclick="expandCollapseEmail('email-${msg.id}', this)" aria-expanded="false">▶</span>
        <div class="email-body" style="display:none">${msg.body?.contentType === 'html' ? msg.body.content : escapeHtml(msg.body?.content || '')}</div>
        <div>
            <button onclick="downloadEmailAsHTML('${msg.id}', '${sanitizeFilename(msg.subject || 'email')}')">Scarica HTML</button>
            <button onclick="saveToGithub({id:'${msg.id}',subject:'${msg.subject}',date:'${msg.receivedDateTime}',from:'${msg.from?.emailAddress?.address}',body:\`${escapeHtml(msg.body?.content || '')}\`})">Salva su GitHub</button>
        </div>
    </div>
    `);
    div.innerHTML = output.join('');
}

// GMAIL
async function loadGmailTab(tab, container) {
    container.innerHTML = `<div id="gmail-content">Caricamento Gmail...</div>`;
    await initializeGapiClient();
    await fetchGmailMessages("gmail-content");
}

// GAPI INIT
async function initializeGapiClient() {
    return new Promise(resolve => {
        gapi.load('client', async () => {
            await gapi.client.init({
                apiKey: 'AIzaSyDY0pP67ezZD9DD38ifNfhKtbz-6ivOulI',
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
            });
            resolve();
        });
    });
}

async function fetchGmailMessages(containerId) {
    const div = document.getElementById(containerId);
    div.innerHTML = 'Caricamento...';
    let messages = [];
    let res = await gapi.client.gmail.users.messages.list({ 'userId': 'me', 'maxResults': 20 });
    if (res.result.messages) messages = res.result.messages;
    let html = '';
    for (const msg of messages) {
        const msgData = await gapi.client.gmail.users.messages.get({ 'userId': 'me', 'id': msg.id });
        const headers = getHeaders(msgData.result.payload.headers);
        const subject = headers['Subject'] || '(Senza oggetto)';
        const from = headers['From'] || '';
        const date = headers['Date'] || '';
        const body = extractBody(msgData.result.payload);
        html += `
        <div class="email" id="email-${msg.id}">
            <strong>Da:</strong> ${escapeHtml(from)}<br>
            <strong>Oggetto:</strong> ${escapeHtml(subject)}
            <span class="email-date">${date}</span>
            <span class="expand-collapse" onclick="expandCollapseEmail('email-${msg.id}', this)" aria-expanded="false">▶</span>
            <div class="email-body" style="display:none">${body}</div>
            <div>
                <button onclick="downloadEmailAsHTML('${msg.id}', '${sanitizeFilename(subject)}')">Scarica HTML</button>
                <button onclick="saveToGithub({id:'${msg.id}',subject:'${subject}',date:'${date}',from:'${from}',body:\`${escapeHtml(body)}\`})">Salva su GitHub</button>
            </div>
        </div>
        `;
    }
    div.innerHTML = html;
}

function getHeaders(headers) {
    const out = {};
    for (const h of headers) out[h.name] = h.value;
    return out;
}
function extractBody(payload) {
    if (payload.parts) {
        for (const part of payload.parts) {
            if (part.mimeType === "text/html" && part.body && part.body.data)
                return atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            if (part.parts) return extractBody(part);
        }
    }
    if (payload.body && payload.body.data)
        return atob(payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
    return '';
}

function escapeHtml(text) {
    var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}
window.expandCollapseEmail = function(divId, el) {
    const div = document.getElementById(divId);
    const bodyDiv = div.querySelector('.email-body');
    if (bodyDiv.style.display !== 'none') {
        bodyDiv.style.display = 'none';
        if(el) el.textContent = '▶';
        el.setAttribute('aria-expanded', 'false');
        return;
    }
    bodyDiv.style.display = 'block';
    if(el) el.textContent = '▼';
    el.setAttribute('aria-expanded', 'true');
};

function downloadEmailAsHTML(emailId, filename) {
    const div = document.getElementById(`email-${emailId}`);
    if (!div) return;
    const bodyDiv = div.querySelector('.email-body');
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
}

window.downloadEmailAsHTML = downloadEmailAsHTML;

// GITHUB OAUTH & API
async function githubAuth() {
    if (githubToken && githubUsername) return;
    const clientId = "Iv1.XXXXXX"; // <-- inserisci il tuo GitHub OAuth App client_id
    const redirectUri = window.location.origin + window.location.pathname;
    const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&scope=repo&redirect_uri=${encodeURIComponent(redirectUri)}`;
    window.open(authUrl, "_blank", "width=600,height=700");
    // Attendi l'autorizzazione manuale e la ricezione del token via server-side oppure implementa PKCE.
    alert("Dopo aver autorizzato su GitHub, inserisci manualmente il tuo access token per proseguire.");
    githubToken = prompt("Inserisci il tuo GitHub access token:");
    // Recupera username
    const res = await fetch("https://api.github.com/user", {headers:{"Authorization":"token "+githubToken}});
    const user = await res.json();
    githubUsername = user.login;
}

// Salva email su repo
async function saveToGithub(email) {
    await githubAuth();
    const repoName = "archivio-mail";
    // 1. Crea repo se non esiste
    const repoUrl = `https://api.github.com/repos/${githubUsername}/${repoName}`;
    let repoExists = true;
    let res = await fetch(repoUrl, {headers:{"Authorization":"token "+githubToken}});
    if (res.status === 404) {
        // Crea repo
        await fetch(`https://api.github.com/user/repos`, {
            method: "POST",
            headers: {"Authorization":"token "+githubToken,"Content-Type":"application/json"},
            body: JSON.stringify({
                name: repoName,
                description: "Archivio mail salvate",
                private: true
            })
        });
        repoExists = false;
    }
    // 2. Salva email come file
    const filename = sanitizeFilename(email.subject || "email") + "-" + (Date.now()) + ".html";
    const content = btoa(`<html><body><strong>Oggetto:</strong> ${email.subject}<br><strong>Data:</strong> ${email.date}<br><strong>Da:</strong> ${email.from}<br><hr>${email.body}</body></html>`);
    await fetch(`https://api.github.com/repos/${githubUsername}/${repoName}/contents/${filename}`, {
        method: "PUT",
        headers: {"Authorization":"token "+githubToken,"Content-Type":"application/json"},
        body: JSON.stringify({
            message: "Salva email",
            content: content
        })
    });
    // 3. Aggiorna archivio locale
    archiveEmails.push({...email, id: filename, body: email.body});
    updateArchiveContent();
    alert("Email salvata su GitHub e mostrata in Archivio!");
}
window.saveToGithub = saveToGithub;

</script>
</body>
</html>
