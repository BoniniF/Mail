<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>BoniniF mail storage</title>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #10330a;
            margin: 0;
            padding: 20px;
        }
        h1 { color: #333; }
        button {
            padding: 8px 16px;
            border: none;
            background-color: #4285F4;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover { background-color: #357AE8; }
        #content { margin-top: 20px; }
        .email {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            position: relative;
        }
        .email strong { color: #555; }
        .email-body {
            border: 1px solid #ccc;
            padding: 10px;
            background: white;
            overflow-x: auto;
            margin-top: 10px;
            display: none;
        }
        #bulk-actions {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }
        #bulk-actions label { margin-right: 20px; }
        .email-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }
        #imap-content .email { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        #imap-content .email-body { border: 1px solid #ccc; padding: 10px; background: #fafafa; margin-top: 10px; overflow-x: auto; }
        #tabs-bar { background:rgba(255,255,255,0.3); border-radius:12px; overflow:auto; }
        .tab-btn { border:none; background:transparent; font-size:1.1em; padding:12px 18px; cursor:pointer; }
        .tab-btn.active { background:#013220; color:#fff; border-radius:8px 8px 0 0; }
        .expand-collapse { cursor:pointer; font-size:1.4em; color:#357AE8; user-select:none; margin-right:6px; }
        .expand-collapse[aria-expanded="true"] { color: #013220; }
        .email-date { color:#888; font-size:0.97em; margin-left:12px; }
        .gmail-btn { background:#fff !important; color:#013220 !important; border:1px solid #357AE8 !important; }
        .gmail-btn:hover { background:#e6f0fa !important; }
    </style>
</head>
<body>

<div id="login-popup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:;z-index:9999;display:flex;justify-content:center;align-items:center;">
    <form id="login-form" style="background:rgba(255,255,255,0.3); padding:30px; border-radius:35px; box-shadow:0 0 10px rgba(0,0,0,0.2); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);">
        <h2 style="color:#013220;">Login</h2>
        <input type="text" id="username" placeholder="Username" required style="background:rgba(255,255,255,0.5); border:none; padding:8px; border-radius:4px; color:#013220; margin-bottom:10px;"><br>
        <input type="password" id="password" placeholder="Password" required style="background:rgba(255,255,255,0.5); border:none; padding:8px; border-radius:4px; color:#013220; margin-bottom:20px;"><br>
        <button 
            type="submit"
            style="
                background:#013220;
                color:#fff;
                border:none;
                padding:7px 15px;
                border-radius:6px;
                cursor:pointer;font-size:23px;
                display:block;margin-left:auto;margin-right:auto;">⇮
        </button>
    </form>
</div>

<div id="hud-username" style="
    display:none;
    position:fixed;
    top:0;
    left:50%;
    transform:translateX(-50%);
    background: rgba(255,255,255,0.3);
    color:#013220; 
    padding:8px 22px 12px 22px;
    border-radius:0 0 25px 25px;
    box-shadow:0 2px 12px rgba(0,0,0,.14);
    backdrop-filter:blur(4px); 
    -webkit-backdrop-filter:blur(4px);
    font-size:2em; 
    z-index:10000;">
</div>


<!-- IMAP/Other Email Services -->
<h2>Altri servizi email (IMAP)</h2>
<form id="imap-login-form" style="margin-bottom: 20px;">
    <label>Email: <input type="email" id="imap-email" required></label>
    <label>Password: <input type="password" id="imap-password" required></label>
    <label>Server IMAP: <input type="text" id="imap-host" placeholder="es. imap.libero.it" required></label>
    <label>Porta: <input type="number" id="imap-port" value="993"></label>
    <label>TLS: <input type="checkbox" id="imap-tls" checked></label>
    <button type="submit">Connetti</button>
</form>
<div id="imap-content"></div>

<div>
    <button id="signout_button" style="display:none;">Disconnettiti</button>
    <button id="outlook_login">Accedi con Outlook</button>
    <div id="g_id_onload"
         data-client_id="956804490330-vbmql3c07lr9eqejk11eaiipc76cefdd.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="signin_with"
         data-size="large">
    </div>
</div>

<!-- Bulk actions UI -->
<div id="bulk-actions" style="display:none;">
    <input type="checkbox" id="select_all" /> <label for="select_all"><strong>Seleziona/Deseleziona tutte</strong></label>
    <button onclick="deleteSelectedEmails()">Elimina selezionate</button>
    <button onclick="downloadSelectedEmails('html')">Scarica HTML selezionate</button>
    <span id="selected-count" style="margin-left:15px;color:#148735;font-weight:bold;"></span>
    <button onclick="saveSelectedToAccount()">Salva selezionate su account</button>
</div>



<div id="tabs-bar" style="display:flex;justify-content:center;margin:22px 0;"></div>
<div id="tabs-content"></div>


    
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
let username, mail_user;
const selectedEmails = new Set();
let gapiInited = false, gisInited = false, gmailTokenLoaded = false;
let tokenClient;

// ... tutte le altre parti del tuo codice restano IDENTICHE ...

// PATCH: downloadSelectedEmails forza SEMPRE fetch corpo Gmail e lo cancella subito dopo l'export
async function downloadSelectedEmails(type) {
    const ids = getSelectedEmailIds();
    if (!ids.length) {
        alert('Nessuna email selezionata.');
        return;
    }
    const activeTab = tabs.find(t => t.active);

    for (const id of ids) {
        const container = document.getElementById(`email-${id}`);
        if (!container) continue;
        // Estrai oggetto
        let subject = "email";
        const subjMatch = container.innerHTML.match(/<strong>Oggetto:<\/strong>\s*([^<]*)/);
        subject = subjMatch ? subjMatch[1] : "email";
        const filename = sanitizeFilename(subject);
        const bodyDiv = container.querySelector('.email-body');
        
        // GMAIL: sempre fetch del corpo, e cancella dopo
        if (activeTab.type === 'gmail') {
            bodyDiv.innerHTML = 'Caricamento...';
            try {
                const msg = await gapi.client.gmail.users.messages.get({
                    'userId': 'me',
                    'id': id
                });
                const { html } = extractBodyAndAttachments(msg.result.payload, msg.result.id);
                bodyDiv.innerHTML = html || '<i>Nessun contenuto</i>';
            } catch (e) {
                bodyDiv.innerHTML = '<i>Errore nel caricamento</i>';
            }
        }

        // Ora esporta (sia Outlook che Gmail)
        if (type === 'html') {
            exportSingleToHTML('email-' + id, filename);
        }

        // Dopo l'export, svuota il contenuto così non resta nel DOM
        if (activeTab.type === 'gmail' && bodyDiv) {
            bodyDiv.innerHTML = '';
        }
    }
}
window.downloadSelectedEmails = downloadSelectedEmails;

// ... tutte le altre parti del tuo codice restano IDENTICHE ...

// Funzione di export singolo (già nel tuo codice)
function exportSingleToHTML(divId, filename) {
    const div = document.getElementById(divId);
    if (!div) return;
    const bodyDiv = div.querySelector('.email-body');
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
}

// ... il resto del codice come prima, nessun cambiamento oltre a downloadSelectedEmails ...

</script>
<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
