<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>BoniniF mail storage</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background: #10330a; color: #013220; }
        #login-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 9999;
        }
        #login-form {
            background: rgba(255,255,255,0.3); padding: 30px;
            border-radius: 35px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
        }
        #tabs-bar {
            background: rgba(255,255,255,0.3); border-radius: 12px;
            overflow: auto; display: flex; justify-content: center; margin: 22px 0;
        }
        .tab-btn {
            border: none; background: transparent; font-size: 1.1em;
            padding: 12px 18px; cursor: pointer;
        }
        .tab-btn.active {
            background: #013220; color: #fff; border-radius: 8px 8px 0 0;
        }
        .email { background: white; border: 1px solid #ccc;
            border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        .email-body { border: 1px solid #ccc; padding: 10px;
            background: #fafafa; margin-top: 10px; overflow-x: auto; }
    </style>
</head>
<body>

<div id="login-popup">
    <form id="login-form">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username" required><br>
        <input type="password" id="password" placeholder="Password" required><br>
        <button type="submit">‚áÆ</button>
    </form>
</div>

<div id="hud-username" style="
    display:none; position:fixed; top:0; left:50%; transform:translateX(-50%);
    background: rgba(255,255,255,0.3); padding:8px 22px; border-radius:0 0 25px 25px;
    box-shadow:0 2px 12px rgba(0,0,0,.14); backdrop-filter:blur(4px); font-size:2em; z-index:10000;">
</div>

<div id="tabs-bar"></div>
<div id="tabs-content"></div>

<script>
const tabs = [];

function addTab(type, label, loaderFn) {
    const id = `tab-${type}-${tabs.length}`;
    const tab = { id, type, label, loaded: false, loader: loaderFn };
    tabs.push(tab);
    renderTabs();
    selectTab(id);
}

function renderTabs() {
    const bar = document.getElementById('tabs-bar');
    bar.innerHTML = '';
    tabs.forEach(tab => {
        const btn = document.createElement('button');
        btn.textContent = tab.label;
        btn.className = 'tab-btn';
        btn.onclick = () => selectTab(tab.id);
        bar.appendChild(btn);
    });
    const plus = document.createElement('button');
    plus.textContent = '+';
    plus.className = 'tab-btn';
    plus.onclick = openTabSelector;
    bar.appendChild(plus);
}

function selectTab(tabId) {
    const tab = tabs.find(t => t.id === tabId);
    if (!tab) return;
    const container = document.getElementById('tabs-content');
    if (!tab.loaded) {
        container.innerHTML = '<div style="text-align:center;padding:40px;">Caricamento...</div>';
        tab.loader(tab, container).then(() => { tab.loaded = true; });
    } else {
        container.innerHTML = document.getElementById(tab.id + '-content')?.outerHTML || '';
    }
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const idx = tabs.indexOf(tab);
    const bar = document.getElementById('tabs-bar');
    if (bar && bar.children[idx]) bar.children[idx].classList.add('active');
}

function openTabSelector() {
    const label = prompt('Etichetta scheda?') || 'Nuova';
    const tab = {
        id: `tab-custom-${tabs.length}`,
        type: 'custom',
        label,
        loaded: false,
        loader: async function(tab, container) {
            const tipo = prompt('Tipo di scheda: gmail, outlook, imap');
            if (tipo === 'gmail') { tab.loader = loadGmailTab; tab.type = 'gmail'; await loadGmailTab(tab, container); }
            else if (tipo === 'outlook') { tab.loader = loadOutlookTab; tab.type = 'outlook'; await loadOutlookTab(tab, container); }
            else if (tipo === 'imap') { tab.loader = loadImapTab; tab.type = 'imap'; await loadImapTab(tab, container); }
            else container.innerHTML = "Tipo non riconosciuto.";
        }
    };
    tabs.push(tab);
    renderTabs();
    selectTab(tab.id);
}

async function loadArchivioTab(tab, container) {
    container.innerHTML = '<div id="' + tab.id + '-content">üì• Archivio caricato (mock)</div>';
}
async function loadGmailTab(tab, container) {
    container.innerHTML = '<div id="' + tab.id + '-content">üìß Gmail caricato (mock)</div>';
}
async function loadOutlookTab(tab, container) {
    container.innerHTML = '<div id="' + tab.id + '-content">üì® Outlook caricato (mock)</div>';
}
async function loadImapTab(tab, container) {
    container.innerHTML = '<div id="' + tab.id + '-content">üóÑÔ∏è IMAP caricato (mock)</div>';
}

document.getElementById('login-form').onsubmit = async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    // MOCK login
    if (username && password) {
        localStorage.setItem('mail_user', username);
        localStorage.setItem('mail_authenticated', '1');
        document.getElementById('login-popup')?.remove();

        const hudDiv = document.getElementById('hud-username');
        if (hudDiv) {
            hudDiv.innerHTML = username;
            hudDiv.style.display = 'block';
        }

        addTab('archivio', 'Archivio', loadArchivioTab);

        // Simulate Gmail/Outlook token
        if (Math.random() > 0.5) addTab('gmail', 'Gmail', loadGmailTab);
        if (Math.random() > 0.5) addTab('outlook', 'Outlook', loadOutlookTab);
    }
};

window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('mail_authenticated') === '1' && localStorage.getItem('mail_user')) {
        document.getElementById('login-popup')?.remove();
        const hudDiv = document.getElementById('hud-username');
        if (hudDiv) {
            hudDiv.innerHTML = localStorage.getItem('mail_user');
            hudDiv.style.display = 'block';
        }
        addTab('archivio', 'Archivio', loadArchivioTab);
        if (Math.random() > 0.5) addTab('gmail', 'Gmail', loadGmailTab);
        if (Math.random() > 0.5) addTab('outlook', 'Outlook', loadOutlookTab);
    }
});
</script>

</body>
</html>
