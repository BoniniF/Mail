<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>BoniniF mail storage</title>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #10330a;
            margin: 0;
            padding: 20px;
        }
        h1 { color: #333; }
        button {
            padding: 8px 16px;
            border: none;
            background-color: #4285F4;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        button:hover { background-color: #357AE8; }
        #content { margin-top: 20px; }
        .email {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            position: relative;
        }
        .email strong { color: #555; }
        .email-body {
            border: 1px solid #ccc;
            padding: 10px;
            background: white;
            overflow-x: auto;
            margin-top: 10px;
            display: none;
        }
       #bulk-actions {
    position: fixed;
    left: 50%;
    bottom: 32px;
    transform: translateX(-50%);
    z-index: 10001;
    background: rgba(255,255,255,0.3); /* come login/hud */
    color: #013220;
    border: 1.5px solid #357AE8;
    border-radius: 25px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.12);
    padding: 14px 36px 16px 36px;
    display: none;
    font-size: 1.07em;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    transition: box-shadow 0.2s, background 0.2s;
    align-items: center;
    gap: 18px;
}
/* Responsive: su mobile, più compatta */
@media (max-width:600px) {
    #bulk-actions {
        width: 98vw;
        left: 1vw;
        transform: none;
        padding: 10px 2vw;
        border-radius: 15px;
        font-size: 0.99em;
    }
}
#bulk-actions button {
    background: #013220;
    color: #fff;
    border: none;
    border-radius: 7px;
    padding: 7px 18px;
    margin: 0 7px;
    cursor: pointer;
    font-size: 1em;
    transition: background 0.2s, color 0.15s;
}
#bulk-actions button:hover {
    background: #357AE8;
    color: #fff;
}
#bulk-actions label {
    color: #013220;
    margin-right: 15px;
    font-weight: 600;
}
#bulk-actions input[type="checkbox"] {
    margin-right: 6px;
    transform: scale(1.2);
    accent-color: #357AE8;
}
#selected-count {
    color: #148735;
    font-weight: bold;
    margin-left: 15px;
}

#hud-username {
  display: inline-block;
  position: relative;
  z-index:10; /* per stare sopra */
}

/* Dropdown base nascosto */
#user-dropdown {
    display:block; /* sempre presente per l'animazione! */
    pointer-events:none;

    position:absolute;
    left:50%;
    top:calc(100% + .5em);
    
    min-width :260px ;
    
   background-color:#fff9fa ; 
   border-radius :22px ;
   box-shadow :0px 8px 32px -6px rgba(20,60,30,.12);

   padding :24px ;

   opacity:.08;  
   
      transform:
        translateX(-50%) scale(.4);/* piccolo & centrato */

     transition :
          transform .34s cubic-bezier(.29,.97,.54,1.7),
          opacity .21s cubic-bezier(.33,.82,.46,.98)
      ;

   z-index :99999;


}

/* Bubble effect on hover username or dropdown itself*/
#hud-username:hover + #user-dropdown,
#user-dropdown:hover {
     pointer-events:auto;
     opacity:.995;

     transform:
         translateX(-50%) scale(1.00); /* torna grande e visibile */

}

/* Mostra dropdown all'hover su #hud-username o sulla stessa tendina */
#hud-username:hover + #user-dropdown,
#user-dropdown:hover {
     display:block !important;
     opacity:.995; 
     pointer-events:auto;

     transform :translateX(-50%) scaleY(1);
}

#user-dropdown button {
        margin-bottom :12px ;
        width :100%;
        font-size :1em ;
        border:none ;
        outline:none ;  
        background:#357AE8 ; color:#fff ;
         padding :.7em ;
         border-radius :13pt ; 
         cursor:pointer ; 
         transition :.18s background ;

}
#user-dropdown button:last-child {margin-bottom :0;}
#user-dropdown button:hover {background:#013220;color:white;}


@keyframes bubbleIn {
 from {opacity:.06;transform:translateX(-50%) scale(.15);}
 to {opacity:.995;transform:translateX(-50%) scale(1);}
}

#hud-username:hover + #user-dropdown,
#user-dropdown:hover {
 animation:bubbleIn .42s cubic-bezier(.35,-0.13 ,.72 ,2 ) forwards !important;
 pointer-events:auto!important;}
/* resetta all’uscita mouse (opzionale) */
#user-dropdown:not(:hover):not(#hud-username:hover){
animation:none !important;}
        

@media (max-width:600px) {
    #bulk-actions {
        width: 98vw;
        left: 1vw;
        transform: none;
        padding: 9px 0 9px 0;
        border-radius: 12px;
        font-size: 0.97em;
    }
}
        .email-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }
        #imap-content .email { background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 15px; }
        #imap-content .email-body { border: 1px solid #ccc; padding: 10px; background: #fafafa; margin-top: 10px; overflow-x: auto; }
        #tabs-bar { background:rgba(255,255,255,0.3); border-radius:12px; overflow:auto; }
        .tab-btn { border:none; background:transparent; font-size:1.1em; padding:12px 18px; cursor:pointer; }
        .tab-btn.active { background:#013220; color:#fff; border-radius:8px 8px 0 0; }
        .expand-collapse { cursor:pointer; font-size:1.4em; color:#357AE8; user-select:none; margin-right:6px; }
        .expand-collapse[aria-expanded="true"] { color: #013220; }
        .email-date { color:#888; font-size:0.97em; margin-left:12px; }
        .gmail-btn { background:#fff !important; color:#013220 !important; border:1px solid #357AE8 !important; }
        .gmail-btn:hover { background:#e6f0fa !important; }
    </style>
</head>
<body>

<div id="login-popup" style="position:fixed;top:0;left:0;width:100%;height:100%;background:;z-index:9999;display:flex;justify-content:center;align-items:center;">
    <form id="login-form" style="background:rgba(255,255,255,0.3); padding:30px; border-radius:35px; box-shadow:0 0 10px rgba(0,0,0,0.2); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);">
        <h2 style="color:#013220;">Login</h2>
        <input type="text" id="username" placeholder="Username" required style="background:rgba(255,255,255,0.5); border:none; padding:8px; border-radius:4px; color:#013220; margin-bottom:10px;"><br>
        <input type="password" id="password" placeholder="Password" required style="background:rgba(255,255,255,0.5); border:none; padding:8px; border-radius:4px; color:#013220; margin-bottom:20px;"><br>
        <button 
            type="submit"
            style="
                background:#013220;
                color:#fff;
                border:none;
                padding:7px 15px;
                border-radius:6px;
                cursor:pointer;font-size:23px;
                display:block;margin-left:auto;margin-right:auto;">⇮
        </button>
    </form>
</div>

<div id="hud-username" style="
    display:none;
    position:fixed;
    top:0;
    left:50%;
    transform:translateX(-50%);
    background: rgba(255,255,255,0.3);
    color:#013220; 
    padding:8px 22px 12px 22px;
    border-radius:0 0 25px 25px;
    box-shadow:0 2px 12px rgba(0,0,0,.14);
    backdrop-filter:blur(4px); 
    -webkit-backdrop-filter:blur(4px);
    font-size:2em; 
    z-index:10000;">
</div>
    <div id="user-dropdown">
    <button onclick="alert('Impostazioni')">Impostazioni</button>
    <button onclick="alert('Logout')">Logout</button>
    <!-- altri pulsanti -->
</div>


<!-- IMAP/Other Email Services -->
<h2>Altri servizi email (IMAP)</h2>
<form id="imap-login-form" style="margin-bottom: 20px;">
    <label>Email: <input type="email" id="imap-email" required></label>
    <label>Password: <input type="password" id="imap-password" required></label>
    <label>Server IMAP: <input type="text" id="imap-host" placeholder="es. imap.libero.it" required></label>
    <label>Porta: <input type="number" id="imap-port" value="993"></label>
    <label>TLS: <input type="checkbox" id="imap-tls" checked></label>
    <button type="submit">Connetti</button>
</form>
<div id="imap-content"></div>

<div>
    <button id="signout_button" style="display:none;">Disconnettiti</button>
    <button id="outlook_login">Accedi con Outlook</button>
    <div id="g_id_onload"
         data-client_id="956804490330-vbmql3c07lr9eqejk11eaiipc76cefdd.apps.googleusercontent.com"
         data-context="signin"
         data-ux_mode="popup"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="signin_with"
         data-size="large">
    </div>
</div>

<!-- Bulk actions UI -->
<div id="bulk-actions" style="display:none;">
    <input type="checkbox" id="select_all" /> <label for="select_all"><strong>Seleziona/Deseleziona tutte</strong></label>
    <button onclick="deleteSelectedEmails()">Elimina selezionate</button>
    <button onclick="downloadSelectedEmails('html')">Scarica HTML selezionate</button>
    <span id="selected-count" style="margin-left:15px;color:#148735;font-weight:bold;"></span>
    <button onclick="saveSelectedToAccount()">Salva selezionate su account</button>
</div>



<div id="tabs-bar" style="display:flex;justify-content:center;margin:22px 0;"></div>
<div id="tabs-content"></div>


    
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
let username, mail_user;
const selectedEmails = new Set();
let gapiInited = false, gisInited = false, gmailTokenLoaded = false;
let tokenClient;

const OUTLOOK_CLIENT_ID = '5dcc792b-ad91-4d6b-88e8-44e149c4b885';
const OUTLOOK_REDIRECT_URI = 'https://bonini.hstn.me/mail';
const msalConfig = {
    auth: {
        clientId: OUTLOOK_CLIENT_ID,
        authority: "https://login.microsoftonline.com/common", 
        redirectUri: OUTLOOK_REDIRECT_URI
    }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const loginRequest = {
    scopes: ["Mail.Read", "offline_access", "User.Read"]
};

const tabs = [
    {
        id: "tab-archivio",
        type: "archivio",
        label: "Archivio",
        loader: loadArchivioTab,
        alwaysReload: true
    }
];
let tabCounter = 1;

function renderTabs() {
    const bar = document.getElementById('tabs-bar');
    bar.innerHTML = '';
    tabs.forEach((tab) => {
        const btn = document.createElement('button');
        btn.textContent = tab.label;
        btn.className = 'tab-btn' + (tab.active ? ' active' : '');
        btn.onclick = () => selectTab(tab.id);
        bar.appendChild(btn);
    });
    const plus = document.createElement('button');
    plus.textContent = '+';
    plus.className = 'tab-btn';
    plus.onclick = openTabSelector;
    bar.appendChild(plus);
}
function openTabSelector() {
    addTab('vuota', 'Nuova scheda', null);
}
function addTab(type, label, loaderFn) {
    const id = `tab-${type}-${++tabCounter}`;
    tabs.push({ id, type, label, loader: loaderFn, loaded: false });
    selectTab(id);
    renderTabs();
}
function selectTab(tabId) {
    tabs.forEach(t => t.active = (t.id === tabId));
    renderTabs();
    const tab = tabs.find(t => t.id === tabId);
    const container = document.getElementById('tabs-content');
    if (tab.type === 'vuota') {
        container.innerHTML = `<div id="${tab.id}-content">Seleziona un servizio per questa scheda.</div>`;
    } else if (tab.alwaysReload) {
        tab.loader(tab, container);
    } else if (tab.loader) {
        tab.loader(tab, container);
        tab.loaded = true;
    }
}
window.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('mail_authenticated') === '1' && localStorage.getItem('mail_user')) {
        username = mail_user = localStorage.getItem('mail_user');
        document.getElementById('login-popup')?.remove();
        const hudDiv = document.getElementById('hud-username');
        if (hudDiv) {
            hudDiv.innerHTML = username;
            hudDiv.style.display = 'block';
        }
        renderTabs();
        selectTab(tabs[0].id);
    } else {
        renderTabs();
    }
});
document.getElementById('login-form').onsubmit = async function(e) {
    e.preventDefault();
    username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    try {
        const res = await fetch('./login.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username, password})
        });
        const result = await res.json();
        if (result.status && (result.status === "success" || result.status === "created")) {
            localStorage.setItem('mail_user', username);
            localStorage.setItem('mail_authenticated', '1');
            window.USERNAME = username;
            mail_user = username;
            const hudDiv = document.getElementById('hud-username');
            if(hudDiv) {
                hudDiv.innerHTML = username;
                hudDiv.style.display = 'block';
            }
            document.getElementById('login-popup')?.remove();
            renderTabs();
            selectTab(tabs[0].id);
        } else {
            alert(result.error || "Errore di autenticazione.");
        }
    } catch (err) {
        alert("Errore durante il login: " + err);
    }
};

// OUTLOOK LOGIN
document.getElementById('outlook_login').onclick = async function() {
    const activeTab = tabs.find(t => t.active);
    if (activeTab && activeTab.type === 'vuota') {
        try {
            const loginResponse = await msalInstance.loginPopup(loginRequest);
            const account = loginResponse.account;
            const accessTokenResponse = await msalInstance.acquireTokenSilent({
                ...loginRequest,
                account: account
            }).catch(() => {
                return msalInstance.acquireTokenPopup(loginRequest);
            });

            const accessToken = accessTokenResponse.accessToken;
            localStorage.setItem('outlook_access_token', accessToken);
            // Trasforma la scheda
            activeTab.type = 'outlook';
            activeTab.label = 'Outlook';
            activeTab.loader = loadOutlookTab;
            selectTab(activeTab.id);
        } catch (error) {
            alert("Errore login Outlook: " + error);
        }
    } else {
        alert('Seleziona una scheda vuota per accedere a Outlook.');
    }
};

// GMAIL LOGIN
window.handleCredentialResponse = function(response) {
    // Credenziali ottenute da Google One Tap
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw(resp);
        gmailTokenLoaded = true;
        localStorage.setItem('gmail_access_token', resp.access_token);
        // Salva anche su backend, opzionale
        if (mail_user) {
            fetch('./update_token.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: mail_user,
                    gmail_token: resp.access_token
                })
            }).catch(err => console.error("Errore aggiornamento token Gmail:", err));
        }
        // Promuovi la scheda vuota a Gmail
        const activeTab = tabs.find(t => t.active && t.type === 'vuota');
        if (activeTab) {
            activeTab.type = 'gmail';
            activeTab.label = 'Gmail';
            activeTab.loader = loadGmailTab;
            selectTab(activeTab.id);
        }
    };
    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
};

// GAPI INIT
window.gapiLoaded = function() {
    gapi.load('client', initializeGapiClient);
    };


async function downloadSelectedEmails(type) {
    const ids = getSelectedEmailIds();
    if (!ids.length) {
        alert('Nessuna email selezionata.');
        return;
    }
    const activeTab = tabs.find(t => t.active);

    if (activeTab.type === "gmail") {
        for (const id of ids) {
            const container = document.getElementById(`email-${id}`);
            if (!container) continue;
            let subject = "email";
            const subjMatch = container.innerHTML.match(/<strong>Oggetto:<\/strong>\s*([^<]*)/);
            subject = subjMatch ? subjMatch[1] : "email";
            const filename = sanitizeFilename(subject);

            // FORZA caricamento corpo mail come richiesto
            const bodyDiv = container.querySelector('.email-body');
            bodyDiv.innerHTML = 'Caricamento...';
            // Carica il messaggio completo
            const msg = await gapi.client.gmail.users.messages.get({
                'userId': 'me',
                'id': id
            });
            const { html } = extractBodyAndAttachments(msg.result.payload, msg.result.id);
            bodyDiv.innerHTML = html || '<i>Nessun contenuto</i>';
            bodyDiv.style.display = 'block';
        }
    }

    // Ora scarica tutte
    for (const id of ids) {
        const container = document.getElementById(`email-${id}`);
        if (!container) continue;
        let subject = "email";
        const subjMatch = container.innerHTML.match(/<strong>Oggetto:<\/strong>\s*([^<]*)/);
        subject = subjMatch ? subjMatch[1] : "email";
        const filename = sanitizeFilename(subject);
        if (type === 'html') {
            exportSingleToHTML('email-' + id, filename);
        }
    }
}

    

// Helper: aspetta che bodyDiv sia popolato, massimo timeout ms
async function waitForBodyLoaded(bodyDiv, timeout = 3000) {
    const interval = 50;
    let waited = 0;
    return new Promise(resolve => {
        const check = () => {
            if (
                bodyDiv &&
                bodyDiv.innerHTML.trim() !== '' &&
                bodyDiv.innerHTML.trim() !== 'Caricamento...'
            ) {
                resolve();
            } else if (waited >= timeout) {
                resolve();
            } else {
                waited += interval;
                setTimeout(check, interval);
            }
        };
        check();
    });
}


function exportRawHTML(html, filename) {
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${html}</body></html>`;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
}



// Funzione di export singolo (come nel tuo codice)
function exportSingleToHTML(divId, filename) {
    const div = document.getElementById(divId);
    if (!div) return;
    const bodyDiv = div.querySelector('.email-body');
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
}

// Funzione di export singolo (come nel tuo codice)
function exportSingleToHTML(divId, filename) {
    const div = document.getElementById(divId);
    if (!div) return;
    const bodyDiv = div.querySelector('.email-body');
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], { type: "text/html" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
}
window.downloadSelectedEmails = downloadSelectedEmails;
    
async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: 'AIzaSyDY0pP67ezZD9DD38ifNfhKtbz-6ivOulI',
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
    });
    gapiInited = true;
}
window.gisLoaded = function() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '956804490330-vbmql3c07lr9eqejk11eaiipc76cefdd.apps.googleusercontent.com',
        scope: 'https://mail.google.com/',
        callback: '', // impostata dinamicamente
    });
    gisInited = true;
}

// ARCHIVIO
async function loadArchivioTab(tab, container) {
    const contentId = tab.id + '-content';
    container.innerHTML = `<div id="${contentId}"></div>`;
    await loadSavedEmails(contentId);
}
async function loadSavedEmails(containerId = 'tab-archivio-content') {
    const div = document.getElementById(containerId);
    const user = localStorage.getItem('mail_user');
    if (!user) { div.innerHTML = "Login richiesto."; return; }
    const res = await fetch('./mail_storage_api.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ action: 'list', username: user })
    });
    const files = await res.json();
    if (!Array.isArray(files) || files.length === 0) {
        div.innerHTML = "Nessun archivio salvato.";
        return;
    }
    let html = '<h2>Archivio mail salvate</h2>';
    for (const file of files) {
        const fileId = 'saved-' + file.name.replace(/[^a-z0-9\-_]/gi, '_');
        const meta = parseStorageFilename(file.name);
html += `
    <div class="email" id="${fileId}">
        <strong>Oggetto:</strong> ${meta.subject}<br>
        <strong>Data:</strong> ${meta.date}<br>
        <strong>Da:</strong> ${meta.from}<br>
        <span class="expand-collapse" onclick="expandCollapseSaved('${file.name}', '${fileId}', this)" aria-expanded="false">▶</span>
        <div class="email-body"></div>
        <div>
            <button onclick="exportSavedToHTML('${file.name}', '${fileId}')">Scarica HTML</button>
            <button onclick="deleteSavedEmail('${file.name}', '${fileId}')">Elimina</button>
        </div>
    </div>
        `;
    }
    div.innerHTML = html;
}
window.expandCollapseSaved = async function(filename, fileId, el) {
    const username = localStorage.getItem('mail_user');
    const div = document.getElementById(fileId);
    const bodyDiv = div.querySelector('.email-body');
    if (bodyDiv.style.display !== 'none') {
        bodyDiv.style.display = 'none';
        if(el) el.textContent = '▶';
        el.setAttribute('aria-expanded', 'false');
        return;
    }
    bodyDiv.innerHTML = 'Caricamento...';
    if(el) el.textContent = '▼';
    el.setAttribute('aria-expanded', 'true');
    const res = await fetch('./mail_storage_api.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ action: 'get', username, filename })
    });
    const data = await res.json();
    bodyDiv.innerHTML = data.html || 'Errore.';
    bodyDiv.style.display = 'block';
};

    //window.exportSavedToHTML = function(filename, fileId) {
 //   const div = document.getElementById(fileId);
 //   const bodyDiv = div.querySelector('.email-body');
//    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
//    const blob = new Blob([htmlContent], {type: "text/html"});
  //  const link = document.createElement("a");
    //link.href = URL.createObjectURL(blob);
   // link.download = filename;
   // link.click();
//};

// OUTLOOK
async function loadOutlookTab(tab, container) {
    const contentId = tab.id + '-content';
    container.innerHTML = `<div id="${contentId}"></div>`;
    await fetchOutlookMessages(localStorage.getItem('outlook_access_token') || '', contentId);
}
async function fetchOutlookMessages(token, containerId) {
    const div = document.getElementById(containerId);
    div.innerHTML = 'Caricamento email Outlook...';
    selectedEmails.clear();
    if (!token) {
        div.innerHTML = 'Token Outlook non trovato. Fai login.';
        return;
    }
    const res = await fetch('https://graph.microsoft.com/v1.0/me/mailfolders/inbox/messages?$top=50', {
        headers: { Authorization: `Bearer ${token}` }
    });

    if (res.status === 401) {
        alert("Token Outlook non valido. Effettua di nuovo il login.");
        localStorage.removeItem('outlook_access_token');
        div.innerHTML = 'Token scaduto. Fai login Outlook.';
        return;
    }
    const data = await res.json();
    if (!data.value || !Array.isArray(data.value) || data.value.length === 0) {
        div.innerHTML = 'Nessun messaggio trovato nella casella Outlook.';
        return;
    }
   const output = data.value.map(msg => `
    <div class="email" id="email-${msg.id}">
        <input type="checkbox" class="email-checkbox" data-id="${msg.id}" onchange="onEmailCheckboxChange(this)">
        <strong>Da:</strong> ${msg.from?.emailAddress?.name || ''} &lt;${msg.from?.emailAddress?.address || ''}&gt;
        <span class="email-date">${msg.receivedDateTime ? new Date(msg.receivedDateTime).toLocaleString() : ''}</span><br>
        <strong>Oggetto:</strong> ${msg.subject || '(Senza oggetto)'}
        <span class="expand-collapse" onclick="expandCollapseEmail('email-${msg.id}', this)" aria-expanded="false">▶</span>
        <div class="email-body">${msg.body?.contentType === 'html' ? msg.body.content : escapeHtml(msg.body?.content || '')}</div>
        <div>
            <button onclick="exportOutlookToHTML('email-${msg.id}', '${sanitizeFilename(msg.subject || 'email')}')">Scarica HTML</button>
            <button onclick="deleteOutlookEmail('${msg.id}')">Elimina</button>
            <button onclick="saveEmailToAccount('${sanitizeFilename(msg.subject || 'email')}', 'email-${msg.id}')">Salva su account</button>
        </div>
    </div>
    `);
    div.innerHTML = output.join('');
    document.querySelectorAll(`#${containerId} .email-body`).forEach(e=>e.style.display='none');
}

// GMAIL <button style="float:right" onclick="exportOutlookToHTML('email-${msg.id}')">Scarica HTML</button>
async function loadGmailTab(tab, container) {
    const contentId = tab.id + '-content';
    container.innerHTML = `<div id="${contentId}"></div>`;
    await fetchGmailMessages(contentId);
}
async function fetchGmailMessages(containerId) {
    const div = document.getElementById(containerId);
    div.innerHTML = 'Caricamento...';
    selectedEmails.clear();
    if (!gapiInited) {
        div.innerHTML = 'Google API non inizializzata.';
        return;
    }
    let messages = [];
    let nextPageToken = null;
    do {
        const res = await gapi.client.gmail.users.messages.list({
            'userId': 'me',
            'maxResults': 30,
            'pageToken': nextPageToken
        });
        if (res.result.messages) {
            messages = messages.concat(res.result.messages);
        }
        nextPageToken = res.result.nextPageToken;
    } while (nextPageToken && messages.length < 50);
    if (messages.length === 0) {
        div.innerHTML = 'Nessun messaggio trovato.';
        return;
    }
    const output = [];
    for (const message of messages) {
        const msg = await gapi.client.gmail.users.messages.get({
            'userId': 'me',
            'id': message.id,
            'format': 'metadata',
            'metadataHeaders': ['Subject', 'From', 'Date']
        });
        const headers = msg.result.payload.headers;
        const subject = headers.find(h => h.name === 'Subject')?.value || '(Senza oggetto)';
        const from = headers.find(h => h.name === 'From')?.value || '(Sconosciuto)';
        const date = msg.result.internalDate
            ? (new Date(Number(msg.result.internalDate))).toLocaleString()
            : (headers.find(h => h.name === 'Date')?.value || '');
        const divId = `email-${msg.result.id}`;
output.push(`
    <div class="email" id="${divId}">
        <input type="checkbox" class="email-checkbox" data-id="${msg.result.id}" onchange="onEmailCheckboxChange(this)">
        <strong>Da:</strong> ${from} <span class="email-date">${date}</span><br>
        <strong>Oggetto:</strong> ${subject}<br>
        <span class="expand-collapse" onclick="expandCollapseGmail('${msg.result.id}', this, '${sanitizeFilename(subject)}')" aria-expanded="false">▶</span>
        <div class='email-body' id='body-${msg.result.id}'></div>
        <div>
            <button onclick="exportGmailToHTML('email-${msg.result.id}', '${sanitizeFilename(subject)}')">Scarica HTML</button>
            <button onclick="deleteGmailEmail('${msg.result.id}')">Elimina</button>
        <button onclick="saveEmailToAccount('${sanitizeFilename(subject)}', 'email-${msg.result.id}')">Salva su account</button>
        </div>
    </div>
        `);
    }
    div.innerHTML = output.join('');
}
    
// Espansione/collapse per Outlook e Gmail  <div class="email-body"></div>
    
window.expandCollapseEmail = function(divId, el) {
    const bodyDiv = document.getElementById(divId).querySelector('.email-body');
    if (bodyDiv.style.display !== 'none') {
        bodyDiv.style.display = 'none';
        el.textContent = '▶'; el.setAttribute('aria-expanded', 'false');
    } else {
        bodyDiv.style.display = 'block';
        el.textContent = '▼'; el.setAttribute('aria-expanded', 'true');
    }
};
window.exportOutlookToHTML = function(divId) {
    const div = document.getElementById(divId);
    const bodyDiv = div.querySelector('.email-body');
    const htmlContent = `<html><head><meta charset="UTF-8"><title>email</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "email.html";
    link.click();
};

window.expandCollapseGmail = async function(msgId, el, filename) {
    const div = document.getElementById(`email-${msgId}`);
    const bodyDiv = div.querySelector('.email-body');
    if (bodyDiv.style.display !== 'none') {
        bodyDiv.style.display = 'none'; el.textContent = '▶'; el.setAttribute('aria-expanded', 'false');
        return;
    }
    bodyDiv.innerHTML = 'Caricamento...';
    el.textContent = '▼'; el.setAttribute('aria-expanded', 'true');
    // Carica il messaggio completo
    const msg = await gapi.client.gmail.users.messages.get({
        'userId': 'me',
        'id': msgId
    });
    const { html } = extractBodyAndAttachments(msg.result.payload, msg.result.id);
    bodyDiv.innerHTML = html || '<i>Nessun contenuto</i>';
    bodyDiv.style.display = 'block';
};
window.exportGmailToHTML = function(divId, filename) {
    const div = document.getElementById(divId);
    const bodyDiv = div.querySelector('.email-body');
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
};

// Bulk actions (valide per TUTTE le tab: tutte le checkbox sono .email-checkbox ovunque)
function onEmailCheckboxChange(checkbox) {
    const id = checkbox.getAttribute('data-id');
    if (checkbox.checked) {
        selectedEmails.add(id);
    } else {
        selectedEmails.delete(id);
    }
    renderBulkActions();
}
window.exportGmailToHTML = async function(divId, filename) {
    const div = document.getElementById(divId);
    const bodyDiv = div.querySelector('.email-body');
    // Se ancora chiusa, aprila e attendi caricamento
    if (bodyDiv.style.display === 'none' || !bodyDiv.innerHTML) {
        await window.expandCollapseGmail(divId.replace('email-',''), null, filename);
    }
    const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
    const blob = new Blob([htmlContent], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename + ".html";
    link.click();
};
window.deleteGmailEmail = async function(id) {
    if (!confirm("Eliminare definitivamente questa email?")) return;
    await gapi.client.gmail.users.messages.delete({'userId': 'me', 'id': id});
    document.getElementById(`email-${id}`)?.remove();
};
    
function renderBulkActions() {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    const bulkActions = document.getElementById('bulk-actions');
    const selectAllCheckbox = document.getElementById('select_all');
    const selectedCountSpan = document.getElementById('selected-count');
    bulkActions.style.display = checkboxes.length > 0 ? 'block' : 'none';
    selectAllCheckbox.checked = (
        checkboxes.length > 0 &&
        [...checkboxes].every(cb => cb.checked)
    );
    selectedCountSpan.textContent = selectedEmails.size > 0 ? `Selezionate: ${selectedEmails.size}` : '';
}
document.getElementById('select_all').addEventListener('change', function () {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    for (const cb of checkboxes) {
        cb.checked = this.checked;
        const id = cb.getAttribute('data-id');
        if (this.checked) selectedEmails.add(id);
        else selectedEmails.delete(id);
    }
    renderBulkActions();
});

window.deleteOutlookEmail = async function(id) {
    if (!confirm("Eliminare questa email da Outlook?")) return;
    const token = localStorage.getItem('outlook_access_token');
    await fetch(`https://graph.microsoft.com/v1.0/me/messages/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
    });
    document.getElementById(`email-${id}`)?.remove();
};

    
// Elimina email selezionate (solo Gmail, puoi adattare per Outlook)
async function deleteSelectedEmails() {
    const ids = Array.from(selectedEmails);
    if (!ids.length) {
        alert('Nessuna email selezionata.');
        return;
    }
    // Se l'utente è su Gmail tab, elimina da Gmail
    const activeTab = tabs.find(t => t.active);
    if (activeTab && activeTab.type === 'gmail') {
        if (!confirm(`Eliminare definitivamente ${ids.length} email selezionate?`)) return;
        for (const id of ids) {
            try {
                await gapi.client.gmail.users.messages.delete({'userId': 'me', 'id': id});
                const emailDiv = document.getElementById(`email-${id}`);
                if (emailDiv) emailDiv.remove();
                selectedEmails.delete(id);
            } catch (e) {
                alert(`Errore su ${id}: ${e.message || e}`);
            }
        }
    } else {
        // Outlook/archivio: puoi aggiungere qui la logica
        alert('Eliminazione multipla solo per Gmail in questa demo.');
    }
    renderBulkActions();
    alert('Email selezionate eliminate.');
}
window.deleteSelectedEmails = deleteSelectedEmails;
window.onEmailCheckboxChange = onEmailCheckboxChange;

// GMAIL: helpers
function extractBodyAndAttachments(payload, messageId) {
    let html = '';
    function traverse(parts) {
        for (const part of parts) {
            if (part.mimeType === 'text/html' && part.body?.data) {
                html = decodeBase64Url(part.body.data);
            } else if (part.parts) {
                traverse(part.parts);
            }
        }
    }
    if (payload.parts) {
        traverse(payload.parts);
    } else if (payload.body?.data) {
        html = decodeBase64Url(payload.body.data);
    }
    return {html};
}
function decodeBase64Url(base64) {
    const decoded = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
    const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
    const decoder = new TextDecoder('utf-8');
    return decoder.decode(bytes);
}
function sanitizeFilename(name) {
    return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
}
function escapeHtml(text) {
    return text ? text.replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m])) : '';
}

function getSelectedEmailIds() {
        return Array.from(selectedEmails);
    }

async function saveEmailToAccount(filename, divId) {
    const bodyDiv = document.getElementById(divId).querySelector('.email-body');
    if (!bodyDiv.innerHTML || bodyDiv.style.display === 'none') {
        // Espandi prima
        await expandEmail(divId.replace('email-', ''), filename);
    }
    const html = document.getElementById(divId).querySelector('.email-body').innerHTML;
    const username = localStorage.getItem('mail_user');
    if (!username) {
        alert("Login richiesto");
        return;
    }

    const res = await fetch('./save_html.php', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({username, filename, html})
    });

    const data = await res.json();
    if (data.success) {
        alert('Mail salvata con successo.');
    } else {
        alert('Errore salvataggio: ' + (data.message || ''));
    }
}
window.saveEmailToAccount = saveEmailToAccount;
    
async function saveSelectedToAccount() {
    const ids = getSelectedEmailIds();
    if (!ids.length) {
        alert('Nessuna email selezionata.');
        return;
    }
    for (const id of ids) {
        const container = document.getElementById(`email-${id}`);
        let subject = "email";
        if (container) {
            const subjMatch = container.innerHTML.match(/<strong>Oggetto:<\/strong>\s*([^<]*)<br>/);
            subject = subjMatch ? subjMatch[1] : "email";
            // Espandi PRIMA di salvare
            await expandEmail(id, sanitizeFilename(subject));
            await saveEmailToAccount(sanitizeFilename(subject), 'email-'+id);
        }
    }
    alert('Email selezionate salvate su account!');
}
window.saveSelectedToAccount = saveSelectedToAccount;

window.exportSavedToHTML = function(filename, fileId) {
    const div = document.getElementById(fileId);
    const bodyDiv = div.querySelector('.email-body');
    // Se ancora chiusa, aprila e attendi
    if (bodyDiv.style.display === 'none' || !bodyDiv.innerHTML) {
        expandCollapseSaved(filename, fileId, null).then(() => {
            doExport();
        });
    } else {
        doExport();
    }
    function doExport() {
        const htmlContent = `<html><head><meta charset="UTF-8"><title>${filename}</title></head><body>${bodyDiv.innerHTML}</body></html>`;
        const blob = new Blob([htmlContent], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename + ".html";
        link.click();
    }
};
window.deleteSavedEmail = async function(filename, fileId) {
    if (!confirm("Eliminare questa email dall'archivio?")) return;
    await fetch('./mail_storage_api.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'delete', username: localStorage.getItem('mail_user'), filename })
    });
    document.getElementById(fileId)?.remove();
};

        
function parseStorageFilename(filename) {
    const sep = '.----------------.';
    const name = filename.replace(/\.html$/i, '');
    const parts = name.split(sep);
    return {
        subject: (parts[0] || '').trim(),
        date: (parts[1] || '').trim(),
        from: (parts[2] || '').trim()
    };
}

    function repositionDropdown() {
 const hud = document.getElementById("hud-username");
 const dd = document.getElementById("user-dropdown");
 if(!hud || !dd) return;

 // Prendi le coordinate relative a viewport dell'HUD
 const rect = hud.getBoundingClientRect();

 dd.style.position = "absolute";
 dd.style.left = rect.left + rect.width /2 +"px";
 dd.style.top=rect.bottom+8+"px";
}
window.addEventListener("resize",repositionDropdown);
// richiama appena mostri HUD username!
document.getElementById('hud-username').addEventListener('mouseenter',repositionDropdown);
</script>
<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
